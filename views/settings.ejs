<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.10.1/css/all.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/settings.css">
</head>

<body>
    <%- include('menu.ejs') %>
        <div class="main-interface">
            <div class="settings-container">
                <div class="settings" id="general-settings">
                    <h2>General</h2>
                    <span>Configure general settings for the application</span>
                    <div class="setting" id="live-required">
                        <div>
                            <h4>Live Required</h4>
                            <span>Does OBS need to be live to track the recording</span>
                        </div>
                        <label class="switch">
                            <input id="liveRequired" type="checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div>
                        <h4>Cleanup Time</h4>
                        <span>Specifiy the time does maintenace</span>
                    </div>
                    <div class="setting" id="cleanup-time">
                        <select id="cleanup-time">
                            <option value="0">Midnight</option>
                            <option value="1">1 AM</option>
                            <option value="2">2 AM</option>
                            <option value="3">3 AM</option>
                            <option value="4">4 AM</option>
                            <option value="5">5 AM</option>
                            <option value="6">6 AM</option>
                            <option value="7">7 AM</option>
                            <option value="8">8 AM</option>
                            <option value="9">9 AM</option>
                            <option value="10">10 AM</option>
                            <option value="11">11 AM</option>
                            <option value="12">Noon</option>
                            <option value="13">1 PM</option>
                            <option value="14">2 PM</option>
                            <option value="15">3 PM</option>
                            <option value="16">4 PM</option>
                            <option value="17">5 PM</option>
                            <option value="18">6 PM</option>
                            <option value="19">7 PM</option>
                            <option value="20">8 PM</option>
                            <option value="21">9 PM</option>
                            <option value="22">10 PM</option>
                            <option value="23">11 PM</option>
                        </select>
                    </div>
                    <div class="setting" id="platform">
                        <div>
                            <h4>Platform</h4>
                            <span>Specifiy which platform you stream on. Default is twitch</span>
                        </div>
                        <select>
                            <option value="twitch">Twitch</option>
                            <option value="youtube">YouTube</option>
                        </select>
                    </div>
                    <div class="setting api-key-container" id="api-key">
                        <div>
                            <h4>API Key</h4>
                            <span>API key to make requests to the application</span>
                        </div>
                        <div class="api-key-input">
                            <input type="text" id="api-key-input" value=<%=apiKey %> readonly>
                            <button id="new-api-key">
                                <i class="fa-solid fa-sync"></i>
                            </button>
                            <button id="copy-api-key-button">
                                Copy
                            </button>
                        </div>
                    </div>
                </div>
                <div class="settings" id="obs-settings">
                    <h2>OBS Connection</h2>
                    <span>Connection To OBS or Streamlabs OBS is WebSocket Server</span>
                    <form id="obs-settings-form">
                        <label for="host">Host:</label>
                        <input class="settings-input" type="text" id="host" name="host"><br><br>
                        <label for="port">Port:</label>
                        <input class="settings-input" type="text" id="port" name="port"><br><br>
                        <label for="password">Password:</label>
                        <input class="settings-input" type="password" id="password" name="password"><br><br>
                        <button id="obs-button" type="submit">Connect</button>
                    </form>
                </div>
                <div class="settings" id="notification-settings">
                    <h2>Notifications</h2>
                    <span>Configure Notification Settings</span>
                    <div id="discord-settings">
                        <h3 class="notification-app">Discord</h3>
                        <label class="switch" id="discord-toggle">
                            <input type="checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div>
                        <form id="discord-form">
                            <label for="webhook">Discord Webhook:</label>
                            <input class="settings-input" type="text" id="webhook" name="webhook"
                                placeholder="Paste webhook here..." value="<%= discordWebhookURL %>"><br><br>
                            <button id="submit-button" type="submit">Submit</button>
                        </form>
                    </div>
                </div>
                <div class="settings">
                    <h2>Support The Project</h2>
                    <span>Consider supporting the project</span>
                    <div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <script src="/js/base.js"></script>
        <script src="/js/settings.js"></script>
        <script>    var currentPage = window.location.href;
            var menuLinks = document.getElementsByClassName('menu-link');
            for (var i = 0; i < menuLinks.length; i++) {
                var link = menuLinks[i];
                if (currentPage.includes('settings') && link.textContent === 'Settings') {
                    link.classList.add('selected');
                }
            }
            const copyApiKeyButton = document.getElementById('copy-api-key-button');
            const discordForm = document.getElementById('discord-form');
            const webhookInput = document.getElementById('webhook');
            const serverapiKey = '<%= serverKey %>';
            const newApiKeyButton = document.getElementById('new-api-key');
            const discordToggle = document.getElementById('discord-toggle');
            const obsSettingsForm = document.getElementById('obs-settings-form');
            obsSettingsForm.addEventListener('submit', (e) => {
                e.preventDefault(); // Prevent form submission
                const hostInput = document.getElementById('host');
                const portInput = document.getElementById('port');
                const host = hostInput.value.trim();
                const port = portInput.value.trim();
                const validHost = validateHost(host);
                const validPort = validatePort(port);
                if (validHost && validPort) {
                    const settings = {
                        host: host,
                        port: port,
                        password: document.getElementById('password').value
                    };
                    const body = {
                        setting: 'obsSettings',
                        value: settings
                    };
                    fetch('/api/settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    })
                        .then(response => {
                            if (response.ok) {
                                console.log('Settings saved successfully');
                            } else {
                                console.error('Failed to save settings');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                }
            });

            function validateHost(host) {
                const ipPattern = /^(localhost|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})$/;
                return ipPattern.test(host);
            }

            function validatePort(port) {
                return !isNaN(port);
            }

            discordToggle.addEventListener('change', () => {
                const isChecked = discordToggle.querySelector('input').checked;
                const body = {
                    setting: 'discordToggle',
                    value: isChecked,
                };
                fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body),
                })
                    .then(response => {
                        if (response.ok) {
                            console.log('Toggle request sent successfully.');
                        } else {
                            console.error('Toggle request failed.');
                        }
                    })
                    .catch(error => {
                        console.error('Toggle request error:', error);
                    });
            });

            newApiKeyButton.addEventListener('click', updateApiKey);

            discordForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const webhookUrl = webhookInput.value;
                if (isValidUrl(webhookUrl)) {
                    const body = {
                        setting: 'discord',
                        value: webhookUrl,
                    };
                    fetch('/settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(body),
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            console.log(data);
                        })
                        .catch((error) => {
                            console.error('Error:', error);
                        });
                } else {
                    console.log('Invalid webhook URL');
                }
            });
            copyApiKeyButton.addEventListener('click', copyApiKey);
            function copyApiKey() {
                const apiKeyInput = document.getElementById('api-key-input');
                apiKeyInput.select();
                document.execCommand('copy');
                copyApiKeyButton.classList.add('copied');
                setTimeout(() => {
                    copyApiKeyButton.classList.remove('copied');
                }, 1000);
            }

            function isValidUrl(url) {
                const urlPattern = /^(https?:\/\/)?([\w.-]+)\.([a-zA-Z]{2,6})(\/[\w.-]*)*\/?$/;
                return urlPattern.test(url);
            }

            async function updateApiKey(apiKey) {
                try {
                    const response = await fetch('/api/settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': serverapiKey,
                        },
                        body: JSON.stringify({ setting: 'apikey' })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const apiKeyInput = document.getElementById('api-key-input');
                        apiKeyInput.value = data.apiKey;
                        console.log('API key updated successfully');
                    } else {
                        console.error('Failed to update API key');
                    }
                } catch (error) {
                    console.error('Error updating API key:', error);
                }
            }
        </script>
</body>

</html>